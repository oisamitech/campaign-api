# Workflow para executar testes automatizados
# Triggrado em push e pull requests para qualquer branch
name: Tests

# Eventos que acionam o workflow
on:
  # Executa em push para qualquer branch
  push:
    branches: [ "*" ]
  # Executa em pull requests para qualquer branch
  pull_request:
    branches: [ "*" ]

# ConfiguraÃ§Ãµes globais
env:
  # ConfiguraÃ§Ãµes do Node.js
  NODE_VERSION: '20'
  # VariÃ¡veis de ambiente para os testes
  NODE_ENV: test
  DATABASE_URL: "mysql://campaign_user:campaign_password@localhost:3306/campaigns"

# Jobs do workflow
jobs:
  # Job principal para executar os testes
  tests:
    # Sistema operacional: Ubuntu (conforme especificado)
    runs-on: ubuntu-latest
    
    # ServiÃ§os necessÃ¡rios para os testes (MySQL)
    services:
      mysql:
        # Imagem do MySQL 8.0
        image: mysql:8.0
        # VariÃ¡veis de ambiente do MySQL
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: campaigns
          MYSQL_USER: campaign_user
          MYSQL_PASSWORD: campaign_password
        # ConfiguraÃ§Ãµes de porta e health check
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -prootpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    # Etapas do job
    steps:
      # 1. Fazer checkout do cÃ³digo do repositÃ³rio
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      # 2. Configurar Node.js com cache automÃ¡tico do npm
      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Cache automÃ¡tico das dependÃªncias do npm
          cache: 'npm'
          
      # 3. Instalar dependÃªncias do projeto
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          echo "ğŸ”„ Instalando dependÃªncias do projeto..."
          npm ci
          echo "âœ… DependÃªncias instaladas com sucesso!"
          
      # 4. Gerar cliente Prisma
      - name: ğŸ—„ï¸ Gerar cliente Prisma
        run: |
          echo "ğŸ”§ Gerando cliente Prisma..."
          npm run db:generate
          echo "âœ… Cliente Prisma gerado com sucesso!"
          
      # 5. Executar migrations do banco de dados
      - name: ğŸš€ Executar migrations do banco
        run: |
          echo "ğŸ”„ Executando migrations do banco de dados..."
          npm run db:migrate:deploy
          echo "âœ… Migrations executadas com sucesso!"
          
      # 6. Executar testes automatizados
      - name: ğŸ§ª Executar testes automatizados
        run: |
          echo "ğŸš€ Iniciando execuÃ§Ã£o dos testes..."
          npm run test
          echo "ğŸ‰ Testes executados com sucesso!"
          
      # 7. Upload dos resultados em caso de falha (opcional)
      - name: ğŸ“Š Upload de logs em caso de falha
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            *.log
            coverage/
          retention-days: 7